#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Exit on error
set -e

# Store the repository root directory
REPO_ROOT=$(git rev-parse --show-toplevel)

echo "üîç Running pre-commit checks..."

# Run custom guard script to check for file issues
echo "‚öîÔ∏è Running file integrity guard..."
node scripts/precommit-guard.js

# Run frontend linting only on staged files
echo "üßπ Running frontend linting (staged files only)..."

# Get staged JS/JSX files within frontend directory
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^frontend/.*\.(js|jsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | sed 's/^/ - /'
  # Run ESLint on just the staged files from within frontend
  (cd frontend && node ./node_modules/eslint/bin/eslint.js $(echo "$STAGED_FILES" | sed 's#^frontend/##' | tr '\n' ' ') --max-warnings 0)
else
  echo "No staged frontend JS/JSX files to lint. Skipping."
fi

# Ensure we are at repo root for any subsequent steps
cd "$REPO_ROOT"

echo "‚úÖ Pre-commit checks passed!"
