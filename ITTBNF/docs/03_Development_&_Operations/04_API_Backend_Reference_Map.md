# RABS-POC Backend API Reference Map  
_A living document for developers & AI agents_  

> Last updated: 28 Jul 2025  
> Maintainer: “Innovation Stack” 🏀  

---

## 0. Purpose & How to Use  
This document maps every backend surface in **rabs-poc** so we can:  

* Trace exactly which endpoint the frontend calls  
* Confirm which service + DB tables power that endpoint  
* Spot legacy SQLite artifacts or missing PostgreSQL tables  
* Accelerate debugging when “Dashboard says 0₳” 🚨  

Keep this file open while you code.  When you add a new route/service/table **update the table below**.

---

## 1. Backend Route Mapping (`backend/routes/`)  

| Router File | HTTP Method | Path | Description | Request Body / Query | Response Shape |
|-------------|-------------|------|-------------|----------------------|----------------|
| `api/v1/dashboard.js` | GET | `/api/v1/dashboard/financials` | KPI cards (revenue, cost, profit) | `{ period:"day\|week\|fortnight\|month", simulatedDate? }` | `{ revenue, cost, profit, margin }` |
| | GET | `/api/v1/dashboard/timeline` | 48 h timeline master + child cards | `simulatedDate?` | `[ Card ]` |
| | POST | `/api/v1/dashboard/reset` | Reset system data (dev) | none | `{ message }` |
| `api/v1/cards.js` | GET | `/api/v1/cards/master` | List master cards within window | `start, end` | `[ MasterCard ]` |
| | POST | `/api/v1/cards/instance/:id/regenerate` | Regenerate card decomposition | none | `{ regenerated: true }` |
| | POST | `/api/v1/cards/traffic-delay` | Demo: delay cards by minutes | `{ minutes }` | `{ affectedIds }` |
| `routes/participants.js` | CRUD endpoints (`/participants`) | Manage participant records | JSON body per operation | Entity / array |
| … | … | … | **See Appendix A** for full CRUD route list generated by Express router. |

_Why not list every CRUD verb in the table?_  
For Staff/Participants/Vehicles/Venues/Programs the pattern is identical (standard REST).  See the boilerplate in **Appendix A**.

### 1.1 Legacy Routes to Audit
| Router | Path | Notes |
|--------|------|-------|
| `routes/dynamicResources.js` | `/dynamic-resources/demo` | Old SQLite demo – **delete or upgrade** |
| `routes/system.js` | `/system/rebalance` | Hits `debug-rebalance.js`, still SQLite logic |

---

## 2. Service Layer (`backend/services/`)  

| Service | Purpose | DB Tables Touched | Key Functions |
|---------|---------|-------------------|---------------|
| `projectorService.js` | Heart of **TGL** – projects Rules ➜ Loom ➜ weaves History | `rules_*`, `loom_*`, `history_*` | `project()`, `weavePast()`, `detectConflicts()` |
| `eventCardService.js` | Card Decomposition – Loom instance ➜ bus/activity/roster cards | `event_card_map`, `loom_instances` | `generateCards()`, `recalculateFinances()` |
| `dashboardFinanceService.js` | KPI maths inc. SCHADS payroll & admin % | `financial_records`, `settings`, `staff` | `calcPeriod()`, `getKpis()` |
| `timesheetService.js` | Export CSV for Xero/MYOB | `history_*`, `staff` | `generateCsv(period)` |
| `recalculationService.js` | Apply pending enrolment/staff changes then trigger projector | `pending_enrollment_changes`, `pending_staff_changes` | `processPendingChanges()` |
| `participantService.js` | CRUD & helper for supervision multipliers | `participants` | `create`, `update`, `list`, `getSupports()` |
| `rosterService.js` | Staff roster operations | `loom_staff_assignments`, `staff` | `swapShifts()`, `utilisation()` |
| _etc._ | see folder – each domain has a matching service. |

_Note: All services use `getDbConnection()` which now returns a **PostgreSQL wrapper** emulating the old sqlite3 API.  If you add `client.query()` raw PG code you’ll bypass the wrapper._

---

## 3. Controllers (`backend/controllers/`)  

| Controller | Responsibility | Typical Flow |
|------------|----------------|--------------|
| `dashboardController` | Glue between dashboard routes and finance/card services | validate ➜ call `dashboardFinanceService` ➜ send JSON |
| `recalculationController` | `/recalculate` endpoint; feeds `simulatedDate` into `recalculationService` | log ➜ process ➜ return `{ changesProcessed }` |
| `programController` | Rules CRUD then triggers `projectorService.project()` | |
| `plannerController` | Participant planner page helper (program recommendations) | |
| All CRUD controllers | Call matching Service, wrap errors | |

---

## 4. Database Schema Overview  

### 4.1 Operational Core  
`staff`, `participants`, `vehicles`, `venues`, `financial_records`, `settings`

### 4.2 TGL Tables  
* **Rules** – `rules_programs`, `rules_participant_schedule`, `rules_staff_roster`  
* **Loom** – `loom_instances`, `loom_participant_attendance`, `loom_staff_assignments`, `loom_vehicle_assignments`  
* **History Ribbon** – `history_ribbon_shifts`, `history_ribbon_participants`, `history_ribbon_staff`, `payment_diamonds`  

### 4.3 Support / Pending  
`pending_enrollment_changes`, `pending_staff_changes`, `program_enrollments`

> ERD TIP: Rules ➜ Loom (1-to-many projection). Loom row weaves into exactly one History row after completion.

---

## 5. Revolutionary Components  

| Component | Layer | Why It’s Revolutionary |
|-----------|-------|------------------------|
| `projectorService` | TGL Engine | Deterministic projection keeps audit chain intact |
| `eventCardService` | Card Layer | Multi-card explosion enables timeline UI & financial overlay |
| `dashboardFinanceService` | Finance Intelligence | Real-time SCHADS award + admin overhead calc |
| `database.js` (wrapper) | Infrastructure | Seamlessly flips SQLite ➜ PostgreSQL with no service rewrite |
| `quick-setup.js` / `add-data.js` | DevOps | One-command local DB spin-up with sample data |

---

## 6. Frontend API Call Points  

| Page / Component | Endpoint(s) | Expected Return | Notes |
|------------------|-------------|-----------------|-------|
| `Dashboard.jsx` – KPI cards | `/api/v1/dashboard/financials?period=week` | `{ revenue, cost, profit }` | Appears blank → check 500 or 0 rows |
| `TimelineColumn.jsx` | `/api/v1/dashboard/timeline` | `[ Card ]` | Fails when no `event_card_map` rows |
| `MasterSchedule.jsx` | `/api/v1/cards/master?start=&end=` | `[MasterCard]` | Currently shows “Failed to load schedule” |
| `Staff.jsx` | `/api/v1/staff` then `/staff/:id` | `[ Staff ]` & single | **BUG**: test link uses `with-schads` not UUID |
| `ParticipantPlanner.jsx` | `/api/v1/planner/recommendations` | `{ suggestions }` | Service returns placeholder |
| _etc._ | | | See code in `src/api/api.js` |

---

## 7. Data-Flow Debugging Checklist  

1. **Connection Type**  
   * On backend start you must see `Using PostgreSQL database: rabspocdb…`  
   * If you see `SQLite` -> `.env` mis-set or wrapper not imported.

2. **Missing Table**  
   ```
   error: relation "pending_enrollment_changes" does not exist
   ```
   ➜ run `database/migrations/` SQL or manual `CREATE TABLE` (see §4).

3. **Invalid UUID**  
   ```
   invalid input syntax for type uuid: "with-schads"
   ```
   ➜ Frontend hard-coded ID – inspect call stack, fix API param.

4. **Empty Schedule**  
   * Check `master_schedule_items`, `loom_instances`, `event_card_map`.  
   * Run `projectorService.project()` manually:  
     ```bash
     node scripts/prepare-launch.js --project
     ```

5. **Wrapper Edge-Case**  
   * If service uses raw `client.query` you’ll get PG `$1` placeholders; convert `?` or bypass wrapper.

6. **CORS / Port Mismatch**  
   * Backend 3009, Frontend 3008 – update `frontend/src/api/api.js` baseURL.

---

## 8. Next Steps / TODO  

- [ ] Auto-migrate pending* tables in `quick-setup.js`  
- [ ] Replace dummy staff ID in frontend routes  
- [ ] Flesh out `dynamicResourceService` PG queries  
- [ ] Add ERD diagram export linked in this doc  

---

### Appendix A – CRUD Route Patterns  
_All domain routers expose:_  

```text
GET    /<entity>          – list  
GET    /<entity>/:id      – get one  
POST   /<entity>          – create  
PUT    /<entity>/:id      – update  
DELETE /<entity>/:id      – delete
```

Entities: participants, staff, vehicles, venues, programs, rates, schedule, etc.

---

_End of file – keep spicy 🌶️_
